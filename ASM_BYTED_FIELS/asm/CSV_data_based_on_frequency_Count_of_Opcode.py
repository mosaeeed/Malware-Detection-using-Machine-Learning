# Importing libraries and initializing varivables
import numpy as np
import string
import csv

##c_files=['58kxhXouHzFd4g3rmInB','6tfw0xSL2FNHOCJBdlaA','a9oIzfw03ED4lTBCt52Y','cf4nzsoCmudt1kwleOTI','d0iHC6ANYGon7myPFzBe','da3XhOZzQEbKVtLgMYWv','fRLS3aKkijp4GH0Ds6Pv','IidxQvXrlBkWPZAfcqKT','58kxhXouHzFd4g3rmInB']
c_files=[]
path = 'D:/BFCAI/Proj/X/Dynamic_Detection/datasets/asm_to_txt/'
files_not_parsed = []
section_list= []

# Reading ID's and Labels from CSV
malwarelist=np.genfromtxt('trainLabels.csv',delimiter=",",dtype=str)
malwarelist=malwarelist[1:]


# Making the first row that will be the field names in the CSV
c_files=np.load('c_files.npy')
files_not_parsed=np.load('files_not_parsed.npy')
section_list=np.load('sect_list.npy')
opc=np.load('opc_list.npy')
opc=opc.tolist()
opc.append('ID')
opc.append('LABEL')
data_to_write=[]
data_to_write.append(opc)
count = 0
wrong = np.append(c_files,files_not_parsed)

"""This is the main section of the code that read text files and counts frequencies of different
    opcounts in each sample and stores them to the data_to_write list along with their ID's and labels 
"""
for name in malwarelist: 
    
    nam=name[0].strip('"')
    nam=str(nam)
    count=count+1
    print(nam,' ',count)
    temp=[0]*len(opc)    
    nam=path+nam+".txt"
    if name[0].strip('"') not in wrong:
        with open(nam) as f:
            lis=f.readlines()
            for source_lin in lis:
                if source_lin=="\n":
                    continue    
                opco=source_lin[source_lin.find(':')+2:source_lin.find('\\')]         
                temp[opc.index(opco)]=temp[opc.index(opco)]+1
##=================In case of section use this=============================================
                section=source_lin[:source_lin.find(':')+1]
                section=section.translate({ord(c): None for c in string.whitespace})
##========================================================================================
            temp[opc.index('ID')]=name[0].strip('"')
            temp[opc.index('LABEL')]=name[1]
    data_to_write.append(temp)
    
myFile = open('data_opcode.csv', 'w', newline='')  
with myFile:  
    writer = csv.writer(myFile)
    writer.writerows(data_to_write)